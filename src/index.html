<!doctype html>
<html lang="en" class="h-100" data-bs-theme="auto">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Diagrams as code for engineers">

    <base href="./">

    <link rel="icon" type="image/svg+xml" href="res/favicon/favicon.svg">
    <link rel="icon" type="image/png" href="res/favicon/favicon.png">

    <title>DrawTheNet.IO</title>

    <!-- JQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css"
        integrity="sha512-2bBQCjcnw658Lho4nlXJcc6WkV/UxpE/sAokbXPxQNGqmNdQrWqtw26Ns9kFF/yG792pKR1Sx8/Y1Lf1XN4GKA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/js/bootstrap.bundle.min.js"
        integrity="sha512-HvOjJrdwNpDbkGJIG2ZNqDlVqMo77qbs4Me4cah0HoDrfhrbA+8SBlZn1KrvAQw7cILLPFJvdwIgphzQmMm+Pw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- D3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"
        integrity="sha512-vc58qvvBdrDR4etbxMdlTt4GBQk1qjvyORR2nrsPsFPyrs+/u5c3+1Ct6upOgdZoIl7eq6k3a1UPDSNAQi/32A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Ace Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/ace.min.js"
        integrity="sha512-BHJlu9vUXVrcxhRwbBdNv3uTsbscp8pp3LJ5z/sw9nBJUegkNlkcZnvODRgynJWhXMCsVUGZlFuzTrr5I2X3sQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/worker-yaml.min.js"
        integrity="sha512-VBsYq0NQ980CUwJPvhrjkF9FbY6dbN4bgbsByte6X2VfkYylrcmBZT6Ve7fJLqFTNPibhMDWjQ4i9oURmMuNyA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/worker-yaml.min.js"
        integrity="sha512-VBsYq0NQ980CUwJPvhrjkF9FbY6dbN4bgbsByte6X2VfkYylrcmBZT6Ve7fJLqFTNPibhMDWjQ4i9oURmMuNyA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/theme-sqlserver.min.js"
        integrity="sha512-hoqwTsZLk0vYlY96Jgf76OqVR92L6S5ayr01RGvbz0uSJzU6hh3jYq5MM7cKNvncS7ddLly2EkfcvuFiwm948g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/ext-language_tools.min.js"
        integrity="sha512-pGeiKdzOOI7LQFQdSOoweS7JVXdwyKaigCy+04DZ34GzUI+9n0/vEg+pk1cVzN8owSr9c0X7dB/aCLNNvm3S5A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Iconify -->
    <script src="https://code.iconify.design/iconify-icon/3.0.0/iconify-icon.min.js"></script>

    <!-- Fuse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/7.1.0/fuse.min.js"
        integrity="sha512-H1bWCnc4dDJwdioqpOCkU76ZxEdvBvOy9R9Dd9EqftlzQg92owjX5IVdiOw00llAyQFUZJNPrzDnWZ/lZtf25A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- JS-YAML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"
        integrity="sha512-CSBhVREyzHAjAFfBlIBakjoRUKp5h7VSweP0InR/pAJyptH7peuhCsqAI/snV+TwZmXZqoUklpXp6R6wMnYf5Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- jQuery toast -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.js"
        integrity="sha512-zlWWyZq71UMApAjih4WkaRpikgY9Bz1oXIW5G0fED4vk14JjGlQ1UmkGM392jEULP8jbNMiwLWdM8Z87Hu88Fw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.css"
        integrity="sha512-wJgJNTBBkLit7ymC6vvzM1EcSWeM9mmOu+1USHaRBbHkm6W9EgM0HY27+UtUaprntaYQJF75rc8gjxllKs5OIQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Showdown -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"
        integrity="sha512-LhccdVNGe2QMEfI3x4DVV3ckMRe36TfydKss6mJpdHjNFiV07dFpS2xzeZedptKZrwxfICJpez09iNioiSZ3hA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"
        integrity="sha512-EBLzUL8XLl+va/zAsmXwS7Z2B1F9HUHkZwyS/VKwh3S7T/U0nF4BaU29EP/ZSf6zgiIxYAnKLu6bJ8dqpmX5uw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/base16/atelier-cave-light.min.css"
        integrity="sha512-mb7hVnqouaHmHLJYLhdY+kUld4843IHJuRbVbhLXD41EJreUz0AeYU9t0XhwDFtnRVRvnLkbT/Xbjl1sajvpFQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.9.0/highlightjs-line-numbers.min.js"
        integrity="sha512-aq+AjYOhd705Zbk/vy3dBiAvfw0kMikUV2FBy4wUek4jZC2/YvwPK5fw9Ov5cJ/nwRveyiEtz5eezB25fg4U1w=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- LZ-String -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"
        integrity="sha512-qtX0GLM3qX8rxJN1gyDfcnMFFrKvixfoEOwbBib9VafR5vbChV5LeE5wSI/x+IlCkTY5ZFddFDCCfaVJJNnuKQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Luxon -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.7.2/luxon.min.js"
        integrity="sha512-nWT3BmMQkC1jYtKIXgDcHeiq4suByiM3ioS24rDMKITplQHL6/943K2M35I6zCq4t0PaiupBSnq+Ax0ARpZGVQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Select2 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"
        integrity="sha512-nMNlpuaDPrqlEls3IX/Q56H36qvBASwb3ipuo3MxeWbsQB1881ox0cRv7UPTgBlriqoynt35KjEwgGUeUXIPnw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"
        integrity="sha512-RtZU3AyMVArmHLiW0suEZ9McadTdegwbgtiQl5Qqo9kunkVg1ofwueXD8/8wv3Af8jkME3DDe3yLfR8HSJfT2g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-5-theme/1.3.0/select2-bootstrap-5-theme.min.css"
        integrity="sha512-z/90a5SWiu4MWVelb5+ny7sAayYUfMmdXKEAbpj27PfdkamNdyI3hcjxPxkOPbrXoKIm7r9V2mElt5f1OtVhqA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- jsTree -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.17/themes/default/style.min.css"
        integrity="sha512-A5OJVuNqxRragmJeYTW19bnw9M2WyxoshScX/rGTgZYj5hRXuqwZ+1AVn2d6wYTZPzPXxDeAGlae0XwTQdXjQA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.17/jstree.min.js"
        integrity="sha512-Rzhxh2sskKwa+96nRopp/hvGexBzEPG6mnFI6uRy059FZfksJJFYmqDFn050KUDhivXLsT6SvoaEf5iSp2SHjg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Google Palette -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/google-palette/1.1.1/palette.min.js"
        integrity="sha512-QVlsdAh4LnoshYICl5ZKM6c5Jei4hIQDPO0/qLbOxTG69sFulGva++89OEDu0O9kX/8Q0xet+OOPrNA2XEsTWQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="res/css/app.css">
    <link rel="stylesheet" href="res/css/notes.css">
</head>

<body class="d-flex flex-column h-100">
    <!-- Loading Screen -->
    <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #212529; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem; margin-bottom: 1.5rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h2 class="text-light mb-2">Loading DrawTheNet.IO</h2>
        <p class="text-muted">Please wait while we prepare your workspace...</p>
    </div>

    <header id="topBar">
        <!-- Fixed navbar -->
        <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <div class="container-fluid">
                <div class="navbar-brand">

                    <div class="bg-light d-inline-block rounded">
                        <img src="res/logo.png" class="d-inline-block " alt="DrawTheNet.IO" width="40" height="40">
                    </div>
                    DrawTheNet.IO

                </div>
                <div class="btn-toolbar justify-content-between">

                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-info" id="btnFullscreen" title="Toggle Fullscreen Mode">
                            <iconify-icon inline icon="bi:arrows-fullscreen"></iconify-icon> Fullscreen
                        </button>
                        <button type="button" class="btn btn-warning" id="btnReduce" title="Exit Fullscreen Mode"
                            style="display: none;">
                            <iconify-icon inline icon="bi:arrows-angle-contract"></iconify-icon> Reduce
                        </button>
                        <button type="button" class="btn btn-danger" title="App's Help Guide" data-bs-toggle="modal"
                            data-bs-target="#modLibrary">
                            <iconify-icon inline icon="ion:library-sharp"></iconify-icon> Library
                        </button>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown"
                                title="Complete icons sets on a single diagram">
                                <iconify-icon inline icon="mdi:grid"></iconify-icon> Contact Sheets
                            </button>
                            <ul class="dropdown-menu" id="drpdwn-contact">
                            </ul>
                        </div>

                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                <iconify-icon inline icon="mdi:file-document-multiple"></iconify-icon> Samples
                            </button>
                            <ul class="dropdown-menu" id="drpdwn-samples">
                            </ul>
                        </div>
                        <button type="button" class="btn btn-success" title="App's Help Guide" data-bs-toggle="modal"
                            data-bs-target="#modHelp">
                            <iconify-icon inline icon="oi:book"></iconify-icon> User Guide
                        </button>
                        <button type="button" class="btn btn-info" title="Application Settings" data-bs-toggle="modal"
                            data-bs-target="#modSettings">
                            <iconify-icon inline icon="mdi:cog"></iconify-icon> Settings
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="h-100">
        <div class="container-fluid h-100">
            <div class="row h-100 gx-0">
                <div id="editorCol" class="col-md-5 h-100">
                    <div class="row h-100 gx-0">
                        <div class="col-md-4 h-100 bg-dark-subtle d-flex flex-column">
                            <div class="p-3">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" type="button" id="btnUpdate" title="Last update: --:--:--">
                                        <iconify-icon inline icon="zondicons:reload"></iconify-icon> Update
                                    </button>

                                    <div class="btn-group" role="group">
                                        <button class="btn btn-primary" type="button" id="btnSaveToLibrary">
                                            <iconify-icon inline icon="material-symbols:save"></iconify-icon> Save to Library
                                        </button>
                                        <button class="btn btn-warning" type="button" id="btnSaveToURL" title="Save to URL">
                                            <iconify-icon inline icon="material-symbols:link"></iconify-icon> Save to URL
                                        </button>
                                    </div>

                                    <div class="btn-group" role="group">
                                        <button class="btn btn-secondary" type="button" id="btnCopyShareLink" title="Copy Share Link to Clipboard">
                                            <iconify-icon inline icon="material-symbols:content-copy"></iconify-icon> Share Link
                                        </button>
                                        <button class="btn btn-info" type="button" id="btnCopyFullscreenLink" title="Copy Fullscreen Link to Clipboard">
                                            <iconify-icon inline icon="material-symbols:fullscreen"></iconify-icon> Fullscreen Link
                                        </button>
                                    </div>
                                </div>

                                <hr class="my-3">

                                <h6 class="text-center fw-bold mb-">Save & Export</h6>

                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-outline-primary" title="Export YAML code"
                                        id="btnSaveYAML">
                                        <iconify-icon inline icon="bi:filetype-yml"></iconify-icon> Save Code
                                    </button>

                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-primary" title="Export as PNG"
                                            id="btnSavePNG">
                                            <iconify-icon inline icon="bi:filetype-png"></iconify-icon> PNG
                                        </button>
                                        <button type="button" class="btn btn-success" title="Export as SVG"
                                            id="btnSaveSVG">
                                            <iconify-icon inline icon="bi:filetype-svg"></iconify-icon> SVG
                                        </button>
                                    </div>
                                </div>

                                <hr class="my-3">

                                <h6 class="text-center fw-bold mb-1">Icon Explorer</h6>

                                <div class="mb-2">
                                    <label for="inpIconSets" class="form-label small fw-semibold ms-1">Icon Sets</label>
                                    <select class="form-select form-select-sm" id="inpIconSets" multiple></select>
                                </div>

                                <div class="mb-2">
                                    <label for="inpSearchIcon" class="form-label small fw-semibold ms-1">Search
                                        Query</label>
                                    <input class="form-control form-control-sm" type="text"
                                        placeholder="Type here to search..." id="inpSearchIcon">
                                </div>

                                <div class="mb-2">
                                    <label for="inpSearchIcon" class="form-label small fw-semibold ms-1">Selected Icon
                                        Preview</label>
                                    <div class="card card-body p-2 mb-2" id="iconSearchFull" style="cursor: pointer;">
                                        <img id="imgIconSearchPreview" class="img-fluid"
                                            style="max-height: 60px; object-fit: contain;">
                                    </div>
                                </div>

                                <div class="small">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">Family</span>
                                        <span id="iconSearchFamily"
                                            class="text-primary text-end ms-2 flex-shrink-1 text-truncate"
                                            style="cursor: pointer;" title="">
                                            <span id="iconFamilyName">-</span>
                                        </span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">Icon</span>
                                        <span id="iconSearchIcon"
                                            class="text-primary text-end ms-2 flex-shrink-1 text-truncate"
                                            style="cursor: pointer;" title="">
                                            <span id="iconIconName">-</span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex-grow-1 overflow-hidden px-3 pb-3">
                                <div id="iconSearchResults" class="h-100 overflow-auto bg-white rounded p-2 border">
                                    <div class='text-center text-muted p-3'><small>Search above, results will be
                                            displayed
                                            here</small></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-8 h-100">
                            <div class="row h-100 gx-0">
                                <div id="editor" class="h-100"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-7 h-100" id="previewCol" style="position: relative;">
                    <div class="h-100" id="preview"></div>
                    <!-- Reset Zoom Button (in preview area) -->
                    <button type="button" class="btn btn-info btn-sm" id="btnResetZoom"
                        style="position: absolute; bottom: 20px; left: 20px; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.2s;"
                        title="Reset Zoom">
                        <iconify-icon inline icon="mdi:magnify-expand"></iconify-icon>
                    </button>
                </div>
            </div>

        </div>
    </main>


    <!-- Fullscreen Preview Container -->
    <div id="fullscreenPreview"
        style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; background: white;">
        <!-- Reset zoom button will be moved here in fullscreen mode -->
    </div>

    <!-- Floating Edit Button (shown in fullscreen mode) -->
    <button type="button" class="btn btn-primary btn-sm" id="btnFloatingEdit"
        style="display: none; position: fixed; top: 20px; right: 20px; z-index: 10000; opacity: 0.3; transition: opacity 0.2s;"
        title="Exit Fullscreen / Edit">
        <iconify-icon inline icon="mdi:pencil"></iconify-icon>
    </button>

    <!-- Floating Export Buttons (shown in fullscreen mode) -->
    <div class="btn-group btn-group-sm" id="btnFloatingExport" role="group"
        style="display: none; position: fixed; bottom: 20px; right: 20px; z-index: 10000; opacity: 0.3; transition: opacity 0.2s;">
        <button type="button" class="btn btn-primary" id="btnFloatingSavePNG" title="Export as PNG">
            <iconify-icon inline icon="bi:filetype-png"></iconify-icon> PNG
        </button>
        <button type="button" class="btn btn-success" id="btnFloatingSaveSVG" title="Export as SVG">
            <iconify-icon inline icon="bi:filetype-svg"></iconify-icon> SVG
        </button>
    </div>

    <div class="modal fade" id="modHelp" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">
                        <small>DrawTheNet.IO</small> - Help & Infos
                        <a href="./help.html" target="_blank" title="Open in a separate tab">
                            <iconify-icon inline icon="material-symbols:open-in-new"></iconify-icon>
                        </a>
                    </h1>
                    <button type="button" class="btn-close me-1" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-2" id="helpModalBody">
                    <!-- Iframe will be loaded conditionally via JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modSettings" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">
                        <iconify-icon inline icon="mdi:cog"></iconify-icon> Settings
                    </h1>
                    <button type="button" class="btn-close me-1" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <h5 class="mb-3">Application Settings</h5>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header bg-success-subtle">
                                        <h6 class="mb-0">Auto-Update</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                id="settingsAutoUpdate" checked>
                                            <label class="form-check-label" for="settingsAutoUpdate">
                                                Enable automatic preview rendering when typing stops or on window resize
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header bg-info-subtle">
                                        <h6 class="mb-0">Auto-Save</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                id="settingsAutoSave" checked>
                                            <label class="form-check-label" for="settingsAutoSave">
                                                Automatically save document to browser IndexedDB and encode into URL hash. Documents are auto-saved every minute when modified.
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header bg-primary-subtle">
                                        <h6 class="mb-0">SVG Export Options</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                id="settingsIncludeYamlInSvg" checked>
                                            <label class="form-check-label" for="settingsIncludeYamlInSvg">
                                                Include YAML code in a hidden SVG tag
                                            </label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                id="settingsEmbedFontsInSvg" checked>
                                            <label class="form-check-label" for="settingsEmbedFontsInSvg">
                                                Embed fonts in SVG export. Without it, the host rendering the svg must
                                                have the fonts (Roboto & Roboto Mono) installed. Without it the
                                                rendering may differ.
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="w-100 d-flex justify-content-between align-items-center">
                        <small class="text-muted">Build Date: <span id="buildDate">%%BUILD_DATE%%</span></small>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Library Modal -->
    <div class="modal fade" id="modLibrary" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">
                        <iconify-icon inline icon="ion:library-sharp"></iconify-icon> Document Library
                    </h1>
                    <div class="btn-group btn-group-sm me-2">
                        <button type="button" class="btn btn-outline-primary" id="btnExportLibrary" title="Export entire library to JSON">
                            <iconify-icon inline icon="mdi:database-export"></iconify-icon> Export
                        </button>
                        <button type="button" class="btn btn-outline-success" id="btnImportLibrary" title="Import library from JSON">
                            <iconify-icon inline icon="mdi:database-import"></iconify-icon> Import
                        </button>
                    </div>
                    <button type="button" class="btn-close me-1" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <input type="file" id="fileImportLibrary" accept=".json" style="display: none;" />
                <div class="modal-body p-0">
                    <div class="container-fluid h-100">
                        <div class="row" style="min-height: 600px;">
                            <!-- Document List (1/3) -->
                            <div class="col-md-4 border-end p-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">Saved Documents</h6>
                                    <button class="btn btn-sm btn-outline-danger" id="btnClearAutoSaves"
                                        title="Clear all autosaves">
                                        <iconify-icon inline icon="mdi:delete-sweep"></iconify-icon>
                                    </button>
                                </div>

                                <div id="libraryDocumentList" class="overflow-auto" style="max-height: 550px;">
                                    <div class="text-center text-muted p-3">
                                        <small>No documents saved yet</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Document Preview (2/3) -->
                            <div class="col-md-8 p-3">
                                <div id="libraryPreviewContainer">
                                    <div class="text-center text-muted p-5">
                                        <iconify-icon icon="mdi:file-document-outline"
                                            style="font-size: 4rem;"></iconify-icon>
                                        <p class="mt-3">Select a document to preview</p>
                                    </div>
                                </div>

                                <div id="libraryPreviewContent" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <h5 id="libraryDocName" class="mb-0">Document Name</h5>
                                            <small class="text-muted" id="libraryDocTimestamp"></small>
                                        </div>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-success" id="btnLoadDocument">
                                                <iconify-icon inline icon="mdi:folder-open"></iconify-icon> Load
                                            </button>
                                            <button class="btn btn-sm btn-warning" id="btnRenameDocument">
                                                <iconify-icon inline icon="mdi:rename"></iconify-icon> Rename
                                            </button>
                                            <button class="btn btn-sm btn-danger" id="btnDeleteDocument">
                                                <iconify-icon inline icon="mdi:delete"></iconify-icon> Delete
                                            </button>
                                        </div>
                                    </div>

                                    <div id="libraryPreviewSVG" class="border rounded bg-light">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { Render as Renderer } from './res/js/render.js';
        import { ExportPNG, ExportSVG, LoadFonts } from './res/js/exporters.js';
        import { initDB, saveDocument, getDocument, getAllDocuments, deleteDocument, clearAutoSaves, saveOrUpdateAutoSave, getLatestAutoSaveContent, getLatestDocument, exportLibrary, importLibrary } from './res/js/db.js';

        $(async function () {
            // Initialize IndexedDB
            await initDB();

            // =============================================
            // =============== Param Loading ===============
            // =============================================
            function genParamString(obj) {
                let urlParams = new URLSearchParams();

                urlParams.set("fullscreen", obj.fullscreen);
                urlParams.set("zoomEnabled", obj.zoomEnabled);
                urlParams.set("autosave", obj.autosave);
                urlParams.set("autoupdate", obj.autoupdate);
                urlParams.set("includeYamlInSvg", obj.includeYamlInSvg);
                urlParams.set("embedFontsInSvg", obj.embedFontsInSvg);
                urlParams.set("doc", LZString.compressToEncodedURIComponent(obj.doc));

                return urlParams.toString();
            }

            function parseParamString(paramString) {
                let urlParams = new URLSearchParams(paramString);

                let returnObj = {
                    "fullscreen": urlParams.get("fullscreen") === "true",
                    "zoomEnabled": urlParams.get("zoomEnabled") !== "false",
                    "autosave": urlParams.get("autosave") !== "false",
                    "autoupdate": urlParams.get("autoupdate") !== "false",
                    "includeYamlInSvg": urlParams.get("includeYamlInSvg") !== "false",
                    "embedFontsInSvg": urlParams.get("embedFontsInSvg") !== "false",
                    "doc": LZString.decompressFromEncodedURIComponent(urlParams.get("doc"))
                };
                return returnObj;
            }

            async function LoadParams() {
                let returnObj = parseParamString(window.location.hash.substring(1));

                if (returnObj.doc == null || returnObj.doc == "") {
                    // Try to load the latest document (autosave or manual save)
                    const latestDoc = await getLatestDocument();
                    
                    if (latestDoc && latestDoc.content) {
                        returnObj.doc = latestDoc.content;
                    } else {
                        // If no saved documents exist, load the welcome.yaml
                        returnObj.doc = await fetch("./samples/welcome.yaml").then(r => r.text());
                    }
                }

                return returnObj;
            }

            function SetParams(params, pushHistory = false) {
                const hash = '#' + genParamString(params);
                if (pushHistory) {
                    history.pushState(null, null, hash);
                } else {
                    history.replaceState(null, null, hash);
                }
            }

            // =============================================
            // ============== Editor & Hl.js ===============
            // =============================================

            // Highlight.js Init
            hljs.highlightAll();

            // Ace Editor Init & settings
            ace.config.set("basePath", "https://cdnjs.cloudflare.com/ajax/libs/ace/1.15.0/");

            let langTools = ace.require("ace/ext/language_tools");

            var editor = ace.edit("editor");
            editor.setTheme("ace/theme/sqlserver");
            editor.session.setMode("ace/mode/yaml");
            editor.setOption("tabSize", 2);
            editor.setOption("wrap", true);
            editor.setOption("enableBasicAutocompletion", true);
            editor.setOption("enableLiveAutocompletion", true);
            editor.setShowPrintMargin(false);

            // Autocompletion keywords and values based on the YAML schema
            let completerKeywords = {
                "diagram": ["columns", "rows", "width", "height", "meta", "title", "icons", "groups", "connections", "notes"],
                "meta": ["title", "author", "company", "date", "version", "filename", "description"],
                "title": ["border", "position", "text", "subText", "author", "company", "date", "version", "color", "stroke", "fill", "heightPercentage", "padding", "logoUrl", "logoIcon", "logoIconFamily", "logoFill"],
                "icons": ["iconFamily", "icon", "text", "x", "y", "w", "h", "margin", "padding", "textSizeRatio", "textLocation", "url", "color", "fill", "stroke", "strokeDashArray", "iconFill", "iconStroke", "iconStrokeWidth", "preserveWhite", "metadata", "animated", "animationSpeed"],
                "groups": ["members", "padding", "textSizeRatio", "textLocation", "color", "fill", "stroke", "strokeDashArray", "text", "animated", "animationSpeed"],
                "connections": ["endpoints", "curve", "curveOffset", "textSizeRatio", "endpLabelOffsetRatio", "margin", "color", "stroke", "strokeDashArray", "strokeWidth", "animated", "animationSpeed", "text"],
                "notes": ["x", "y", "xAlign", "yAlign", "alignItems", "flexDirection", "justifyContent", "w", "h", "margin", "padding", "textSizeRatio", "color", "fill", "stroke", "strokeDashArray", "text"]
            };

            let completerValues = {
                "iconFamily": ["AWS", "Azure", "Cisco", "D365", "Fortinet", "GCP", "M365", "PowerPlatform", "Iconify"],
                "logoIconFamily": ["AWS", "Azure", "Cisco", "D365", "Fortinet", "GCP", "M365", "PowerPlatform", "Iconify"],
                "textLocation": ["center", "topLeft", "topCenter", "topRight", "rightTop", "rightCenter", "rightBottom", "bottomLeft", "bottomCenter", "bottomRight", "leftTop", "leftCenter", "leftBottom"],
                "position": ["top", "bottom", "none"],
                "border": ["bar", "none"],
                "curve": ["linear", "curved", "step", "stepReversed", "stepBefore", "stepAfter"],
                "xAlign": ["left", "center", "right"],
                "yAlign": ["top", "center", "bottom"],
                "flexDirection": ["row", "column"],
                "animationSpeed": ["slow", "medium", "fast"],
                "iconFamily": ["Iconify", "AWS", "Azure", "Cisco", "GCP", "K8S", "M365"]
            };

            let completer = {
                getCompletions: function (editor, session, pos, prefix, callback) {
                    let line = session.getLine(pos.row);
                    let linePrefix = line.substring(0, pos.column);

                    // Detect indentation level
                    let indentLevel = linePrefix.search(/\S|$/);

                    // Get all lines up to current position to determine context
                    let allLines = session.getLines(0, pos.row);
                    let context = determineContext(allLines, pos.row, indentLevel);

                    let completions = [];

                    // Check if we're after a colon (suggesting a value)
                    let colonMatch = linePrefix.match(/(\w+):\s*$/);
                    if (colonMatch) {
                        let propertyName = colonMatch[1];

                        // Suggest boolean values
                        if (["invertY", "gridLines", "watermark", "animated", "preserveWhite"].includes(propertyName)) {
                            completions.push(
                                { caption: "true", value: "true", meta: "boolean", score: 1000 },
                                { caption: "false", value: "false", meta: "boolean", score: 1000 }
                            );
                        }

                        // Suggest predefined values
                        if (completerValues[propertyName]) {
                            completions = completerValues[propertyName].map(val => ({
                                caption: val,
                                value: '"' + val + '"',
                                meta: "value",
                                score: 1000
                            }));
                        }

                        // Suggest number defaults
                        if (["columns", "rows", "renderRatio", "schemasVersion", "version", "heightPercentage"].includes(propertyName)) {
                            let defaults = { columns: 10, rows: 10, renderRatio: 3, schemasVersion: 1, version: 1, heightPercentage: 6 };
                            if (defaults[propertyName]) {
                                completions.push({ caption: String(defaults[propertyName]), value: String(defaults[propertyName]), meta: "number", score: 1000 });
                            }
                        }

                        // Suggest color values
                        if (["fill", "color", "stroke", "iconFill", "logoFill"].includes(propertyName)) {
                            let colors = ["white", "black", "red", "blue", "green", "yellow", "gray", "lightgray", "darkgray"];
                            completions = colors.map(color => ({
                                caption: color,
                                value: '"' + color + '"',
                                meta: "color",
                                score: 900
                            }));
                        }

                        callback(null, completions);
                        return;
                    }

                    // Property name suggestions based on context
                    let keywords = [];

                    if (context === "root") {
                        keywords = completerKeywords.root;
                    } else if (context === "document") {
                        keywords = completerKeywords.document;
                    } else if (context === "diagram") {
                        keywords = completerKeywords.diagram;
                    } else if (context === "title") {
                        keywords = completerKeywords.title;
                    } else if (context === "icon" || context === "icons") {
                        keywords = completerKeywords.icon;
                    } else if (context === "group" || context === "groups") {
                        keywords = completerKeywords.group;
                    } else if (context === "connection" || context === "connections") {
                        keywords = completerKeywords.connection;
                    } else if (context === "note" || context === "notes") {
                        keywords = completerKeywords.note;
                    } else if (context === "margin") {
                        keywords = completerKeywords.margin;
                    } else if (context === "padding") {
                        keywords = completerKeywords.padding;
                    }

                    completions = keywords.map(keyword => ({
                        caption: keyword,
                        value: keyword + ": ",
                        meta: context || "property",
                        score: 1000
                    }));

                    callback(null, completions);
                }
            };

            function determineContext(lines, currentRow, indentLevel) {
                // Walk backwards to find the context
                for (let i = currentRow; i >= 0; i--) {
                    let line = lines[i].trim();
                    if (line === "") continue;

                    let lineIndent = lines[i].search(/\S|$/);

                    // If we're at root level (no indent)
                    if (indentLevel === 0) {
                        return "root";
                    }

                    // If this line has less indentation, it's our parent context
                    if (lineIndent < indentLevel) {
                        // Check if it's a root-level keyword
                        if (line.startsWith("document:")) return "document";
                        if (line.startsWith("diagram:")) return "diagram";
                        if (line.startsWith("title:")) return "title";
                        if (line.startsWith("icons:")) return "icon";
                        if (line.startsWith("groups:")) return "group";
                        if (line.startsWith("connections:")) return "connection";
                        if (line.startsWith("notes:")) return "note";

                        // Check for nested properties
                        if (line.startsWith("margin:")) return "margin";
                        if (line.startsWith("padding:")) return "padding";

                        // If it's an item in a list under icons/groups/etc
                        if (line.match(/^-\s+{/) || line.match(/^\w+:\s*{/)) {
                            // Look further up for the parent section
                            for (let j = i - 1; j >= 0; j--) {
                                let parentLine = lines[j].trim();
                                if (parentLine.startsWith("icons:")) return "icon";
                                if (parentLine.startsWith("groups:")) return "group";
                                if (parentLine.startsWith("connections:")) return "connection";
                                if (parentLine.startsWith("notes:")) return "note";
                            }
                        }
                    }
                }

                return "root";
            }

            langTools.setCompleters([completer]);

            // Data storage Init
            var Data = {};

            // =============================================
            // ======= Settings & session loading ==========
            // =============================================

            let params = await LoadParams();

            editor.setValue(params.doc, -1);

            // Also update URL to ensure params are persisted
            SetParams(params, false);

            // Settings modal synchronization
            $('#settingsAutoSave').change(async function () {
                params = await LoadParams();
                params.autosave = $(this).is(":checked");
                SetParams(params, false);
            });

            $('#settingsAutoUpdate').change(async function () {
                params = await LoadParams();
                params.autoupdate = $(this).is(":checked");
                SetParams(params, false);
            });

            $('#settingsIncludeYamlInSvg').change(async function () {
                params = await LoadParams();
                params.includeYamlInSvg = $(this).is(":checked");
                SetParams(params, false);
            });

            $('#settingsEmbedFontsInSvg').change(async function () {
                params = await LoadParams();
                params.embedFontsInSvg = $(this).is(":checked");
                SetParams(params, false);
            });

            // Sync settings modal when opened
            $('#modSettings').on('show.bs.modal', async function () {
                params = await LoadParams();
                $('#settingsAutoSave').prop('checked', params.autosave);
                $('#settingsAutoUpdate').prop('checked', params.autoupdate);
                $('#settingsIncludeYamlInSvg').prop('checked', params.includeYamlInSvg);
                $('#settingsEmbedFontsInSvg').prop('checked', params.embedFontsInSvg);
            });

            // =============================================
            // =============== Help Modal ==================
            // =============================================

            // Only load help iframe if not already in an iframe
            $('#modHelp').on('show.bs.modal', function () {
                const isInIframe = window.self !== window.top;
                const helpModalBody = document.getElementById('helpModalBody');

                // Only load the iframe once and only if not already in an iframe
                if (!isInIframe && helpModalBody.children.length === 0) {
                    helpModalBody.innerHTML = '<iframe class="w-100" height="800px" src="./help.html"></iframe>';
                } else if (isInIframe && helpModalBody.children.length === 0) {
                    // If in iframe, provide a link to open help in new tab instead
                    helpModalBody.innerHTML = `
                        <div class="text-center p-5">
                            <p class="mb-3">Help is not available in embedded mode.</p>
                            <a href="./help.html" target="_blank" class="btn btn-primary">
                                <iconify-icon inline icon="material-symbols:open-in-new"></iconify-icon>
                                Open Help in New Tab
                            </a>
                        </div>
                    `;
                }
            });

            // =============================================
            // ===============  Render =====================
            // =============================================
            let debounceRenderTimer;
            let lastDocument = null;
            let errorToast = null;
            let isFirstRender = true;

            function Render(maxDelay = 2000, keepZoom = true) {
                clearTimeout(debounceRenderTimer);
                debounceRenderTimer = setTimeout(async () => {
                    try {
                        $("#btnUpdate").prop("disabled", true);

                        let text = editor.session.getValue();

                        if (text === null || text === "" || text.trim() === "") {
                            return;
                        }

                        let currentParams = await LoadParams();
                        if (currentParams.autosave) {
                            currentParams.doc = text;
                            SetParams(currentParams, false);
                        }

                        let doc = jsyaml.load(text);
                        Renderer("#preview", doc, keepZoom, currentParams.zoomEnabled);

                        if (errorToast !== null) {
                            errorToast.reset();
                            errorToast = null;
                        }

                        lastDocument = doc;
                        
                        // Update page title with diagram title (after defaults are applied)
                        if (doc.title && doc.title.text) {
                            document.title = `${doc.title.text} - DrawTheNet.IO`;
                        }
                        else {
                            document.title = `DrawTheNet.IO`;
                        }

                        // Hide loading screen after first successful render
                        if (isFirstRender) {
                            isFirstRender = false;
                            setTimeout(() => {
                                const loadingScreen = document.getElementById('loadingScreen');
                                if (loadingScreen) {
                                    loadingScreen.style.opacity = '0';
                                    loadingScreen.style.transition = 'opacity 0.5s ease-out';
                                    setTimeout(() => {
                                        loadingScreen.style.display = 'none';
                                    }, 500);
                                }
                            }, 100);
                        }
                    } catch (e) {
                        console.error(e);
                        errorToast = $.toast({
                            text: `<pre>${e.message}</pre>`,
                            heading: 'Error in document',
                            icon: 'error',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: false,
                            stack: false,
                            position: 'top-right',
                            loader: true
                        });

                        // Hide loading screen even on error during first render
                        if (isFirstRender) {
                            isFirstRender = false;
                            setTimeout(() => {
                                const loadingScreen = document.getElementById('loadingScreen');
                                if (loadingScreen) {
                                    loadingScreen.style.opacity = '0';
                                    loadingScreen.style.transition = 'opacity 0.5s ease-out';
                                    setTimeout(() => {
                                        loadingScreen.style.display = 'none';
                                    }, 500);
                                }
                            }, 100);
                        }
                        return;
                    }
                    finally {
                        $("#btnUpdate").prop("disabled", false);
                    }

                    // Update the tooltip with the last update time
                    let lastUpdateTime = luxon.DateTime.now().toFormat("HH:mm:ss");
                    $("#btnUpdate").attr("title", `Last update: ${lastUpdateTime}`);
                }, maxDelay);
            }

            (async function () {
                let currentParams = await LoadParams();
                if (currentParams.autoupdate) {
                    Render(0);
                }
            })();

            $("#btnUpdate").click(function () {
                Render(0);
            });

            // Debounced auto-save to IndexedDB
            let debounceAutoSaveTimer;

            // Load last autosave content on initialization
            let lastAutoSaveContent = await getLatestAutoSaveContent();

            // Auto Update on change
            const editorChangeHandler = async function (delta) {
                let currentParams = await LoadParams();
                if (currentParams.autoupdate) {
                    Render();
                }
            };
            
            editor.session.on('change', editorChangeHandler);

            // Auto-save to IndexedDB every minute if there are changes
            setInterval(async () => {
                let currentParams = await LoadParams();
                if (!currentParams.autosave) return;

                const content = editor.session.getValue();

                // Only save if content has changed from last autosave
                if (content !== lastAutoSaveContent) {
                    const timestamp = luxon.DateTime.now().toFormat("yyyy-MM-dd HH:mm:ss");
                    await saveOrUpdateAutoSave(content, timestamp);
                    lastAutoSaveContent = content;
                }
            }, 60000); // Save every 60 seconds (1 minute)

            // Auto-save on window unload (before closing/refreshing)
            window.addEventListener("beforeunload", async (event) => {
                let currentParams = await LoadParams();
                if (!currentParams.autosave) return;

                const content = editor.session.getValue();

                // Only save if content has changed from last autosave
                if (content !== lastAutoSaveContent) {
                    const timestamp = luxon.DateTime.now().toFormat("yyyy-MM-dd HH:mm:ss");
                    // Use synchronous approach for beforeunload to ensure it completes
                    await saveOrUpdateAutoSave(content, timestamp);
                    lastAutoSaveContent = content;
                }
            });

            window.addEventListener("resize", async (event) => {
                let currentParams = await LoadParams();
                if (currentParams.autoupdate) {
                    Render(50, false);
                }
            });



            // =============================================
            // ================== Samples ==================
            // =============================================
            fetch("./samples/samples.json")
                .then(response => response.json())
                .then(function (res) {
                    Object.keys(res).forEach(function (category) {
                        $("#drpdwn-samples").append(`<li class="bg-warning"><h6 class="dropdown-header text-center">
                        <iconify-icon icon="ph:caret-down-fill"></iconify-icon>
                        ${category}
                        <iconify-icon icon="ph:caret-down-fill"></iconify-icon>
                        </h6></li>`);

                        Object.keys(res[category]).forEach(function (key) {
                            $("#drpdwn-samples").append(`<li file="${res[category][key]}"><a class="dropdown-item" href="#">${key}</a></li>`);
                        });
                    });
                });

            $("#drpdwn-samples, #drpdwn-contact").on("click", "li", function (event) {
                event.preventDefault();

                let fileName = $(this).attr("file");

                if (fileName === null || fileName === undefined) {
                    event.stopImmediatePropagation();
                    return;
                }

                fetch(`./samples/${fileName}`)
                    .then(response => response.text())
                    .then(function (res) {
                        editor.setValue(res, -1);
                    });

            });


            // =============================================
            // =============== Icons Search ================
            // =============================================
            fetch("./res/icons/icons.json")
                .then(response => response.json())
                .then(function (res) {
                    // Contact Sheets
                    Object.keys(res).forEach(function (key) {
                        $("#drpdwn-contact").append(`<li file="${key.toLowerCase()}.yaml"><a class="dropdown-item" href="#">${key}</a></li>`);
                    });

                    // Icon Explorer
                    $("#inpIconSets").append(`<option value="Iconify" selected>Iconify</option>`);

                    Object.keys(res).forEach(function (key) {
                        $("#inpIconSets").append(`<option value="${key}" selected>${key}</option>`);
                    });

                    // Initialize Select2
                    $('#inpIconSets').select2({
                        placeholder: "Select icon sets",
                        allowClear: true,
                        closeOnSelect: false,
                        width: '100%'
                    });

                    Data.Icons = res;

                    let flattenIcons = [];

                    Object.keys(res).forEach(key => {
                        res[key].forEach(key2 => {
                            flattenIcons.push({ Icon: key2, Family: key });
                        });
                    });

                    Data.IconsFlat = flattenIcons;

                    // Perform default search for "network"
                    $('#inpSearchIcon').val('Network');
                    searchIcons('network');
                });


            let searchOptions = {
                includeScore: true,
                keys: ['Icon', 'Family']
            }


            function searchIcons(search) {
                let iconSets = [];

                iconSets = $("#inpIconSets").val();

                let allIcons = Data.IconsFlat.filter(icon => iconSets.includes(icon.Family));

                if (iconSets.includes("Iconify")) {
                    fetch("https://api.iconify.design/search?query=" + search)
                        .then(response => response.json())
                        .then(function (res) {
                            let iconifyIcons = res.icons.map(icon => {
                                return { Icon: icon, Family: "Iconify" };
                            });

                            let allIcons = Data.IconsFlat.concat(iconifyIcons);

                            let fuse = new Fuse(allIcons, searchOptions);

                            let searchRes = fuse.search(search);

                            RenderSearchResults(searchRes);
                        });
                }
                else {
                    let fuse = new Fuse(allIcons, searchOptions);

                    let searchRes = fuse.search(search);

                    RenderSearchResults(searchRes);
                }
            }

            function RenderSearchResults(searchRes) {
                // Use requestAnimationFrame to sync with browser paint cycle
                requestAnimationFrame(() => {
                    const resultsContainer = document.getElementById("iconSearchResults");

                    if (searchRes.length == 0) {
                        resultsContainer.innerHTML = "<div class='text-center text-muted p-3'><small>No results found</small></div>";
                        return;
                    }

                    let maxSearchResult = 200; // Reduced from 100 to minimize DOM size

                    if (searchRes.length > maxSearchResult) {
                        searchRes.length = maxSearchResult;
                    }

                    // Use array and join instead of string concatenation for better performance
                    const htmlParts = ['<div class="row g-2">'];

                    searchRes.forEach(res => {
                        let icon = res.item.Icon;
                        let family = res.item.Family;

                        let url = `res/icons/${family.toLowerCase()}/${icon.toLowerCase()}.svg`;

                        if (family == "Iconify") {
                            url = `https://api.iconify.design/${icon.replace(":", "/")}.svg`;
                        }

                        htmlParts.push(`
                        <div class="col-6 col-xl-4">
                            <div class="card iconCard h-100" fam="${family}" icon="${icon}" style="cursor: pointer;" title="Family: ${family}&#10;Icon: ${icon}" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>Family:</strong> ${family}<br><strong>Icon:</strong> ${icon}">
                                <div class="card-body p-2 text-center icon-full">
                                    <img src="${url}" class="img-fluid" loading="lazy" style="max-height: 40px; object-fit: contain;">
                                </div>                            
                            </div>
                        </div>
                        `);
                    });

                    htmlParts.push('</div>');
                    resultsContainer.innerHTML = htmlParts.join('');

                    // Initialize Bootstrap tooltips for the newly added elements
                    const tooltipTriggerList = resultsContainer.querySelectorAll('[data-bs-toggle="tooltip"]');
                    [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
                });
            }


            let debounceSearchIconTimer;
            $("#inpSearchIcon").on("input", function (event) {
                clearTimeout(debounceSearchIconTimer);
                debounceSearchIconTimer = setTimeout(() => searchIcons($("#inpSearchIcon").val()), 300);
            });

            // Select2 change event
            $("#inpIconSets").on("change", function (event) {
                clearTimeout(debounceSearchIconTimer);
                debounceSearchIconTimer = setTimeout(() => searchIcons($("#inpSearchIcon").val()), 100);
            });

            $("#iconSearchFamily").on("click", function (event) {
                event.preventDefault();

                let text = $(this).find("span").text().trim();

                navigator.clipboard.writeText(`"${text}"`).then(
                    () => {
                        $.toast({
                            heading: 'Icon family copied to clipboard',
                            icon: 'success',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 2000,
                            position: 'bottom-right',
                            loader: true
                        });
                    },
                    () => {
                        $.toast({
                            heading: 'Icon family copying to clipboard failed. Please allow permission and try again',
                            icon: 'error',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 5000,
                            position: 'bottom-right',
                            loader: true
                        });
                    }
                );
            });

            $("#iconSearchIcon").on("click", function (event) {
                event.preventDefault();

                let text = $(this).find("span").text().trim();

                navigator.clipboard.writeText(`"${text}"`).then(
                    () => {
                        $.toast({
                            heading: 'Icon name copied to clipboard',
                            icon: 'success',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 2000,
                            position: 'bottom-right',
                            loader: true
                        });
                    },
                    () => {
                        $.toast({
                            heading: 'Icon name copying to clipboard failed. Please allow permission and try again',
                            icon: 'error',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 5000,
                            position: 'bottom-right',
                            loader: true
                        });
                    }
                );
            });

            $("#iconSearchResults").on("click", ".icon-full", function (event) {
                event.preventDefault();

                // Remove selected class from all icon cards
                $("#iconSearchResults").find(".iconCard").removeClass("selected");

                // Add selected class to the clicked card
                $(this).parents(".card").addClass("selected");

                let family = $(this).parents(".card").attr("fam");
                let name = $(this).parents(".card").attr("icon");

                let url = `res/icons/${family.toLowerCase()}/${name.toLowerCase()}.svg`;

                if (family == "Iconify") {
                    url = `https://api.iconify.design/${name.replace(":", "/")}.svg`;
                }

                $("#imgIconSearchPreview").attr("src", url);
                $("#iconFamilyName").text(family);
                $("#iconIconName").text(name);

                // Set title attributes for tooltip on hover
                $("#iconSearchFamily").attr("title", family);
                $("#iconSearchIcon").attr("title", name);
            });


            $("#iconSearchFull").on("click", function (event) {
                event.preventDefault();

                let family = $("#iconSearchFamily").find("span").text().trim();
                let name = $("#iconSearchIcon").find("span").text().trim();

                navigator.clipboard.writeText(`iconFamily: "${family}"\r\n icon: "${name}"`).then(
                    () => {
                        $.toast({
                            heading: 'Icon name & family copied to clipboard',
                            icon: 'success',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 2000,
                            position: 'bottom-right',
                            loader: true
                        });
                    },
                    () => {
                        $.toast({
                            heading: 'Icon name & family copying to clipboard failed. Please allow permission and try again',
                            icon: 'error',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 5000,
                            position: 'bottom-right',
                            loader: true
                        });
                    }
                );
            });



            // =============================================
            // ================= Library ===================
            // =============================================

            let selectedDocumentId = null;

            async function refreshLibraryList() {
                const docs = await getAllDocuments();
                const container = $("#libraryDocumentList");

                if (docs.length === 0) {
                    container.html('<div class="text-center text-muted p-3"><small>No documents saved yet</small></div>');
                    return;
                }

                // Sort by timestamp (newest first)
                docs.sort((a, b) => b.timestamp - a.timestamp);

                // Separate autosaves and manual saves
                const autoSaves = docs.filter(doc => doc.isAutoSave);
                const manualSaves = docs.filter(doc => !doc.isAutoSave);

                // Build jsTree data structure
                let treeData = [];

                // Add manual saves folder
                if (manualSaves.length > 0) {
                    let manualChildren = manualSaves.map(doc => {
                        const timestamp = luxon.DateTime.fromMillis(doc.timestamp).toFormat("yyyy-MM-dd HH:mm:ss");
                        return {
                            id: `doc_${doc.id}`,
                            text: doc.name,
                            type: 'file',
                            a_attr: {
                                title: `Saved: ${timestamp}`
                            },
                            data: {
                                docId: doc.id,
                                timestamp: timestamp
                            }
                        };
                    });

                    treeData.push({
                        id: 'saved_docs',
                        text: ` Saved Documents (${manualSaves.length})`,
                        type: 'folder',
                        state: { opened: true },
                        children: manualChildren
                    });
                }

                // Add autosaves folder
                if (autoSaves.length > 0) {
                    let autoChildren = autoSaves.map(doc => {
                        const timestamp = luxon.DateTime.fromMillis(doc.timestamp).toFormat("yyyy-MM-dd HH:mm:ss");
                        return {
                            id: `doc_${doc.id}`,
                            text: doc.name,
                            type: 'file',
                            a_attr: {
                                title: `Auto-saved: ${timestamp}`
                            },
                            data: {
                                docId: doc.id,
                                timestamp: timestamp,
                                isAutoSave: true
                            }
                        };
                    });

                    treeData.push({
                        id: 'auto_saves',
                        text: ` Auto-Saves (${autoSaves.length})`,
                        type: 'folder',
                        state: { opened: true },
                        children: autoChildren
                    });
                }

                // Destroy existing tree if it exists
                try {
                    if (container.jstree(true)) {
                        container.jstree('destroy');
                    }
                } catch (e) {

                }

                // Initialize jsTree
                container.html('');

                try {
                    container.jstree({
                        core: {
                            data: treeData,
                            themes: {
                                name: 'default',
                                responsive: true,
                                dots: false,
                                icons: false
                            }
                        },
                        types: {
                            folder: {},
                            file: {}
                        },
                        plugins: ['types']
                    }).on('select_node.jstree', function (e, data) {
                        if (data.node.data && data.node.data.docId) {
                            previewDocument(data.node.data.docId);
                        }
                    });
                } catch (e) {
                    console.error('jsTree initialization error:', e);
                    container.html('<div class="alert alert-danger">Error initializing tree view</div>');
                }
            }

            async function previewDocument(docId) {
                selectedDocumentId = docId;
                const doc = await getDocument(docId);

                if (!doc) return;

                $("#libraryDocName").text(doc.name);
                $("#libraryDocTimestamp").text(luxon.DateTime.fromMillis(doc.timestamp).toFormat("yyyy-MM-dd HH:mm:ss"));

                // Clear previous content
                $("#libraryPreviewSVG").html('');

                // Show content area
                $("#libraryPreviewContainer").hide();
                $("#libraryPreviewContent").show();

                // Wait for DOM to update and modal to be visible
                await new Promise(resolve => setTimeout(resolve, 100));

                // Render preview
                try {
                    const yamlDoc = jsyaml.load(doc.content);
                    Renderer("#libraryPreviewSVG", yamlDoc, false);
                } catch (e) {
                    $("#libraryPreviewSVG").html(`<div class="text-danger p-3"><strong>Error:</strong> ${e.message}</div>`);
                }
            }

            // Open library modal
            $("#modLibrary").on('show.bs.modal', async function () {
                await refreshLibraryList();
                selectedDocumentId = null;
                $("#libraryPreviewContainer").show();
                $("#libraryPreviewContent").hide();
            });

            // Load document button
            $("#btnLoadDocument").on('click', async function () {
                if (!selectedDocumentId) return;

                const doc = await getDocument(selectedDocumentId);
                if (doc) {
                    editor.setValue(doc.content, -1);
                    $("#modLibrary").modal('hide');
                    Render(0);

                    $.toast({
                        heading: 'Document loaded',
                        text: `Loaded: ${doc.name}`,
                        icon: 'success',
                        showHideTransition: 'slide',
                        allowToastClose: true,
                        hideAfter: 2000,
                        position: 'bottom-right',
                        loader: true
                    });
                }
            });

            // Rename document button
            $("#btnRenameDocument").on('click', async function () {
                if (!selectedDocumentId) return;

                const doc = await getDocument(selectedDocumentId);
                if (!doc) return;

                const newName = prompt('Enter a new name for this document:', doc.name);

                if (newName && newName.trim() !== '' && newName.trim() !== doc.name) {
                    // Update the document with new name
                    doc.name = newName.trim();
                    const db = await initDB();
                    const tx = db.transaction('documents', 'readwrite');
                    const store = tx.objectStore('documents');
                    await store.put(doc);
                    await tx.done;

                    // Refresh the list and preview
                    await refreshLibraryList();
                    $("#libraryDocName").text(doc.name);

                    $.toast({
                        heading: 'Document renamed',
                        text: `Renamed to: ${newName.trim()}`,
                        icon: 'success',
                        showHideTransition: 'slide',
                        allowToastClose: true,
                        hideAfter: 2000,
                        position: 'bottom-right',
                        loader: true
                    });
                }
            });

            // Delete document button
            $("#btnDeleteDocument").on('click', async function () {
                if (!selectedDocumentId) return;

                if (confirm('Are you sure you want to delete this document?')) {
                    await deleteDocument(selectedDocumentId);
                    await refreshLibraryList();
                    selectedDocumentId = null;
                    $("#libraryPreviewContainer").show();
                    $("#libraryPreviewContent").hide();

                    $.toast({
                        heading: 'Document deleted',
                        icon: 'success',
                        showHideTransition: 'slide',
                        allowToastClose: true,
                        hideAfter: 2000,
                        position: 'bottom-right',
                        loader: true
                    });
                }
            });

            // Clear autosaves button
            $("#btnClearAutoSaves").on('click', async function () {
                if (confirm('Are you sure you want to clear all autosaved documents?')) {
                    await clearAutoSaves();
                    await refreshLibraryList();
                    selectedDocumentId = null;
                    $("#libraryPreviewContainer").show();
                    $("#libraryPreviewContent").hide();

                    $.toast({
                        heading: 'Autosaves cleared',
                        icon: 'success',
                        showHideTransition: 'slide',
                        allowToastClose: true,
                        hideAfter: 2000,
                        position: 'bottom-right',
                        loader: true
                    });
                }
            });

            // Save to library button
            $("#btnSaveToLibrary").on('click', async function () {
                const name = prompt('Enter a name for this document:');

                if (name && name.trim() !== '') {
                    const content = editor.session.getValue();
                    await saveDocument(name.trim(), content, false);

                    $.toast({
                        heading: 'Document saved',
                        text: `Saved as: ${name}`,
                        icon: 'success',
                        showHideTransition: 'slide',
                        allowToastClose: true,
                        hideAfter: 2000,
                        position: 'bottom-right',
                        loader: true
                    });
                }
            });

            // Save to URL button
            $("#btnSaveToURL").on('click', async function () {
                const content = editor.session.getValue();
                const compressed = LZString.compressToEncodedURIComponent(content);
                
                // Get current URL parameters
                let currentParams = await LoadParams();
                const urlParams = new URLSearchParams(window.location.search);
                
                // Update the doc parameter
                urlParams.set('doc', compressed);
                
                // Construct the new URL
                const newUrl = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}${window.location.hash}`;
                
                // Update URL in address bar
                window.history.pushState({}, '', newUrl);
                
                $.toast({
                    heading: 'URL updated',
                    text: 'The URL has been updated with your document',
                    icon: 'success',
                    showHideTransition: 'slide',
                    allowToastClose: true,
                    hideAfter: 2000,
                    position: 'bottom-right',
                    loader: true
                });
            });

            // Copy Share Link button
            $("#btnCopyShareLink").on('click', async function () {
                const content = editor.session.getValue();
                const compressed = LZString.compressToEncodedURIComponent(content);
                
                // Get current URL parameters
                let currentParams = await LoadParams();
                const urlParams = new URLSearchParams(window.location.search);
                
                // Update the doc parameter
                urlParams.set('doc', compressed);
                
                // Construct the new URL
                const newUrl = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}${window.location.hash}`;
                
                // Copy to clipboard with HTML format for better link compatibility
                try {
                    // Get diagram title for the link text
                    let diagramTitle = lastDocument && lastDocument.title && lastDocument.title.text ? lastDocument.title.text : 'Diagram';
                    
                    const htmlFragment = `<a href="${newUrl}">${diagramTitle}</a>`;
                    
                    // Create the clipboard data with both HTML and plain text formats
                    const clipboardItem = new ClipboardItem({
                        'text/html': new Blob([htmlFragment], { type: 'text/html' }),
                        'text/plain': new Blob([newUrl], { type: 'text/plain' })
                    });
                    
                    await navigator.clipboard.write([clipboardItem]);
                    
                    $.toast({
                        heading: 'Share link copied',
                        text: 'The share link has been copied to clipboard',
                        icon: 'success',
                        showHideTransition: 'slide',
                        allowToastClose: true,
                        hideAfter: 2000,
                        position: 'bottom-right',
                        loader: true
                    });
                } catch (err) {
                    // Fallback: try simple text copy
                    try {
                        await navigator.clipboard.writeText(newUrl);
                        
                        $.toast({
                            heading: 'Share link copied',
                            text: 'The share link has been copied to clipboard (plain text)',
                            icon: 'success',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 2000,
                            position: 'bottom-right',
                            loader: true
                        });
                    } catch (err2) {
                        $.toast({
                            heading: 'Copy failed',
                            text: 'Unable to copy to clipboard. Please allow clipboard permissions.',
                            icon: 'error',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 3000,
                            position: 'bottom-right',
                            loader: true
                        });
                    }
                }
            });

            // Copy Fullscreen Link button
            $("#btnCopyFullscreenLink").on('click', async function () {
                const content = editor.session.getValue();
                
                // Get current params and ensure fullscreen is true
                let currentParams = await LoadParams();
                currentParams.fullscreen = true;
                currentParams.doc = content;
                
                // Generate URL with fullscreen=true
                const paramString = genParamString(currentParams);
                const newUrl = `${window.location.origin}${window.location.pathname}#${paramString}`;
                
                // Copy to clipboard with HTML format for better link compatibility
                try {
                    // Get diagram title for the link text
                    let diagramTitle = lastDocument && lastDocument.title && lastDocument.title.text ? lastDocument.title.text : 'Diagram';
                    
                    const htmlFragment = `<a href="${newUrl}">${diagramTitle}</a>`;
                    
                    // Create the clipboard data with both HTML and plain text formats
                    const clipboardItem = new ClipboardItem({
                        'text/html': new Blob([htmlFragment], { type: 'text/html' }),
                        'text/plain': new Blob([newUrl], { type: 'text/plain' })
                    });
                    
                    await navigator.clipboard.write([clipboardItem]);
                    
                    $.toast({
                        heading: 'Fullscreen link copied',
                        text: 'The fullscreen link has been copied to clipboard',
                        icon: 'success',
                        showHideTransition: 'slide',
                        allowToastClose: true,
                        hideAfter: 2000,
                        position: 'bottom-right',
                        loader: true
                    });
                } catch (err) {
                    // Fallback: try simple text copy
                    try {
                        await navigator.clipboard.writeText(newUrl);
                        
                        $.toast({
                            heading: 'Fullscreen link copied',
                            text: 'The fullscreen link has been copied to clipboard (plain text)',
                            icon: 'success',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 2000,
                            position: 'bottom-right',
                            loader: true
                        });
                    } catch (err2) {
                        $.toast({
                            heading: 'Copy failed',
                            text: 'Unable to copy to clipboard. Please allow clipboard permissions.',
                            icon: 'error',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 3000,
                            position: 'bottom-right',
                            loader: true
                        });
                    }
                }
            });

            // Export Library button
            $("#btnExportLibrary").on('click', async function () {
                try {
                    const exportData = await exportLibrary();
                    
                    const jsonString = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const timestamp = luxon.DateTime.now().toFormat("yyyy-MM-dd_HH-mm-ss");
                    const filename = `DrawTheNet-Library-${timestamp}.json`;
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                    URL.revokeObjectURL(link.href);
                    
                    $.toast({
                        heading: 'Library exported',
                        text: `Exported ${exportData.documentCount} documents to ${filename}`,
                        icon: 'success',
                        showHideTransition: 'slide',
                        allowToastClose: true,
                        hideAfter: 3000,
                        position: 'bottom-right',
                        loader: true
                    });
                } catch (error) {
                    console.error('Export error:', error);
                    $.toast({
                        heading: 'Export failed',
                        text: error.message || 'An error occurred while exporting the library',
                        icon: 'error',
                        showHideTransition: 'slide',
                        allowToastClose: true,
                        hideAfter: 5000,
                        position: 'bottom-right',
                        loader: true
                    });
                }
            });

            // Import Library button
            $("#btnImportLibrary").on('click', function () {
                $("#fileImportLibrary").click();
            });

            // Handle file import
            $("#fileImportLibrary").on('change', async function (event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const reader = new FileReader();
                    
                    reader.onload = async function (e) {
                        try {
                            const importData = JSON.parse(e.target.result);
                            
                            // Ask user if they want to replace existing data or merge
                            const replaceExisting = confirm(
                                `Import ${importData.documentCount || importData.documents.length} documents?\n\n` +
                                'Click OK to MERGE with existing library\n' +
                                'Click Cancel to abort import'
                            );
                            
                            if (replaceExisting === null) {
                                return; // User cancelled
                            }
                            
                            const result = await importLibrary(importData, false); // Always merge for safety
                            
                            await refreshLibraryList();
                            
                            // Build detailed message
                            let message = `Imported ${result.imported} new documents.`;
                            if (result.updated > 0) {
                                message += ` Updated ${result.updated} with newer versions.`;
                            }
                            if (result.skipped > 0) {
                                message += ` Skipped ${result.skipped} older/duplicate documents.`;
                            }
                            
                            $.toast({
                                heading: 'Library imported',
                                text: message,
                                icon: 'success',
                                showHideTransition: 'slide',
                                allowToastClose: true,
                                hideAfter: 5000,
                                position: 'bottom-right',
                                loader: true
                            });
                        } catch (error) {
                            console.error('Import error:', error);
                            $.toast({
                                heading: 'Import failed',
                                text: error.message || 'Invalid file format or corrupted data',
                                icon: 'error',
                                showHideTransition: 'slide',
                                allowToastClose: true,
                                hideAfter: 5000,
                                position: 'bottom-right',
                                loader: true
                            });
                        }
                    };
                    
                    reader.readAsText(file);
                } catch (error) {
                    console.error('File read error:', error);
                    $.toast({
                        heading: 'File read failed',
                        text: 'Unable to read the selected file',
                        icon: 'error',
                        showHideTransition: 'slide',
                        allowToastClose: true,
                        hideAfter: 5000,
                        position: 'bottom-right',
                        loader: true
                    });
                } finally {
                    // Reset file input
                    event.target.value = '';
                }
            });

            // =============================================
            // =============== FullScreen ==================
            // =============================================

            $("#btnFullscreen, #btnReduce").on("click", async function (event) {
                event.preventDefault();
                let currentParams = await LoadParams();
                currentParams.fullscreen = !currentParams.fullscreen;
                SetParams(currentParams, true);
                await applyFullscreen(currentParams.fullscreen);
            });

            $("#btnFloatingEdit").on("click", async function (event) {
                event.preventDefault();
                let currentParams = await LoadParams();
                currentParams.fullscreen = false;
                SetParams(currentParams, true);
                await applyFullscreen(currentParams.fullscreen);
            });

            // Handle browser back/forward buttons
            window.addEventListener('popstate', async function(event) {
                let currentParams = await LoadParams();
                
                // Check if fullscreen state matches current params
                const isCurrentlyFullscreen = $("#fullscreenPreview").is(":visible");
                if (currentParams.fullscreen !== isCurrentlyFullscreen) {
                    await applyFullscreen(currentParams.fullscreen);
                }
                
                // Update editor content if it changed in history (e.g. undo via back button)
                // Note: This might overwrite unsaved changes if not careful, but since we autosave to history on change,
                // navigating back should just go to previous state.
                if (currentParams.doc && currentParams.doc !== editor.session.getValue()) {
                    // Temporarily disable change handler to avoid triggering autosave/render loop
                    editor.session.off('change', editorChangeHandler);
                    editor.setValue(currentParams.doc, -1);
                    editor.session.on('change', editorChangeHandler);
                    Render(0, false);
                }
            });

            async function applyFullscreen(isFullscreen) {
                // Detect if page is loaded in an iframe
                const isInIframe = window.self !== window.top;

                if (isFullscreen) {
                    // Hide UI elements
                    $("#topBar").hide();
                    $("#editorCol").hide();
                    $("#btnReduce").show();
                    $("#btnFullscreen").hide();

                    // Only show floating buttons if NOT in an iframe
                    if (!isInIframe) {
                        $("#btnFloatingEdit").show();
                        $("#btnFloatingExport").show();
                    } else {
                        $("#btnFloatingEdit").hide();
                        $("#btnFloatingExport").hide();
                    }

                    // Move preview content to fullscreen container
                    $("#previewCol").hide();
                    let previewContent = $("#preview").detach();
                    let resetZoomBtn = $("#btnResetZoom").detach();
                    $("#fullscreenPreview").append(previewContent).append(resetZoomBtn).show();

                    // Update button style for fullscreen (fixed positioning)
                    $("#btnResetZoom").css({
                        "position": "fixed",
                        "bottom": "20px",
                        "left": "20px",
                        "z-index": "10000"
                    });
                }
                else {
                    // Show UI elements first
                    $("#topBar").show();
                    $("#editorCol").show();
                    $("#btnReduce").hide();
                    $("#btnFullscreen").show();
                    $("#btnFloatingEdit").hide();
                    $("#btnFloatingExport").hide();

                    // Move preview content back to original container
                    let previewContent = $("#preview").detach();
                    let resetZoomBtn = $("#btnResetZoom").detach();
                    $("#previewCol").append(previewContent).append(resetZoomBtn).show();
                    $("#fullscreenPreview").hide();

                    // Restore button style for normal mode (absolute positioning)
                    $("#btnResetZoom").css({
                        "position": "absolute",
                        "bottom": "20px",
                        "left": "20px",
                        "z-index": "100"
                    });

                    // When exiting fullscreen, reload the document from URL params into the editor
                    // Temporarily remove change handler to prevent debounced render
                    const currentParams = await LoadParams();
                    if (currentParams.doc) {
                        // Clear any pending debounced renders
                        clearTimeout(debounceRenderTimer);
                        
                        // Temporarily remove the change event handler
                        editor.session.off('change', editorChangeHandler);
                        
                        // Set the editor value
                        editor.setValue(currentParams.doc, -1);
                        
                        // Re-attach the change event handler
                        editor.session.on('change', editorChangeHandler);
                    }
                }

                // Render immediately without debounce
                clearTimeout(debounceRenderTimer);
                Render(0, false);
            }

            if (params.fullscreen) {
                applyFullscreen(params.fullscreen);
            }

            // =============================================
            // =========== Keyboard Shortcut ===============
            // =============================================

            $(document).on("keydown", async function (event) {
                if (event.ctrlKey && event.key == "s") {
                    event.preventDefault();
                    $("#btnSave").click();
                }
                else if (event.ctrlKey && event.key == "Enter") {
                    event.preventDefault();
                    $("#btnFullscreen").click();
                }
                else if (event.key == "Escape") {
                    let currentParams = await LoadParams();
                    if (currentParams.fullscreen) {
                        event.preventDefault();
                        currentParams.fullscreen = false;
                        SetParams(currentParams, true);
                        await applyFullscreen(false);
                    }
                }
            });

            // =============================================
            // =============== Local Save ==================
            // =============================================


            $("#btnSave").on("click", async function (event) {
                let text = editor.session.getValue();

                let params = await LoadParams();
                params.doc = text;
                SetParams(params, false);
            });

            // =============================================
            // ================= Exports ===================
            // =============================================

            // Preloading fonts for PNG export
            LoadFonts();

            function saveAs(blob, title) {
                let link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = title;
                link.click();
                URL.revokeObjectURL(link.href);
            }

            $("#btnSaveYAML").on("click", function (event) {
                event.preventDefault();

                if (lastDocument == null) return;

                let title = `${lastDocument.document.fileTitlePrefix}-${luxon.DateTime.now().toFormat("yyyy-MM-dd_HH-mm-ss")}.yml`

                let text = editor.session.getValue();
                let blob = new Blob([text], { type: "text/plain;charset=utf-8" });

                saveAs(blob, title);
            });


            $("#btnSaveSVG").on("click", async function (event) {
                event.preventDefault();

                if (lastDocument == null) return;

                let title = `${lastDocument.document.fileTitlePrefix}-${luxon.DateTime.now().toFormat("yyyy-MM-dd_HH-mm-ss")}.svg`

                // Get current settings
                let currentParams = await LoadParams();
                let embedFonts = currentParams.embedFontsInSvg;
                let includeYaml = currentParams.includeYamlInSvg;

                // Get YAML code if needed
                let yamlCode = includeYaml ? editor.session.getValue() : null;

                let svg = (await ExportSVG($(".render")[0], lastDocument.document.renderRatio, embedFonts, yamlCode)).outerHTML;
                let blob = new Blob([svg], { type: "image/svg+xml;charset=utf-8" });

                saveAs(blob, title);
            });

            $("#btnSavePNG").on("click", async function (event) {
                event.preventDefault();

                if (lastDocument == null) return;

                let title = `${lastDocument.document.fileTitlePrefix}-${luxon.DateTime.now().toFormat("yyyy-MM-dd_HH-mm-ss")}.png`
                let blob = await ExportPNG($(".render")[0], lastDocument.document.renderRatio);

                saveAs(blob, title);

                return;
            });

            // Floating export buttons (fullscreen mode)
            $("#btnFloatingSavePNG").on("click", function (event) {
                event.preventDefault();
                $("#btnSavePNG").click();
            });

            $("#btnFloatingSaveSVG").on("click", function (event) {
                event.preventDefault();
                $("#btnSaveSVG").click();
            });

            // Handle zoom change event to show/hide reset button
            document.getElementById("preview").addEventListener("zoomchange", function(e) {
                const transform = e.detail;
                const btnResetZoom = document.getElementById("btnResetZoom");
                if (btnResetZoom) {
                    if (transform.k !== 1 || transform.x !== 0 || transform.y !== 0) {
                        btnResetZoom.style.opacity = "0.5";
                        btnResetZoom.style.pointerEvents = "auto";
                    } else {
                        btnResetZoom.style.opacity = "0";
                        btnResetZoom.style.pointerEvents = "none";
                    }
                }
            });

            // Reset Zoom button
            $("#btnResetZoom").on("click", function (event) {
                event.preventDefault();

                // Get the SVG element
                let svg = d3.select("#preview svg");
                if (svg.node() == null) return;

                // Get the zoom behavior from the svg
                let zoom = svg.node().__zoomBehavior;
                if (!zoom) return;

                // Reset to identity transform
                svg.transition()
                    .duration(300)
                    .call(zoom.transform, d3.zoomIdentity);
            });
        });
    </script>
</body>

</html>